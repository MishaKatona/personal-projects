# -*- coding: utf-8 -*-

# This file is responsible for the runing of the simulation consistently over
# Learning, testing, and evaluation, the main loop contains all necessary functions
# From mani_v4 to run the smulation in a single line in a for loop, the agent
# Generation is also present that initialises a specified number of drones
# Restaurants, and charging stations to feed into the main loop

import main_v4 as m
import random
import time
import numpy as np
import demandv2 as dem


# Main loop of the simulation, the main task inclued updating the postions of the drones
# Creating new orders, and then using a generated score matrix assiging each job a drone
def main_loop(drones, restaurants, chargers, jobs_a, jobs_na, jobs_c, t, spawn_prob, size, peak_loc, learning_weights = False):
        
    demand = dem.mapGenerator(size,spawn_prob,peak_loc)
    slow = False
    
    if demand:
        rest, cust_to_charge = m.pick_restaurant(demand, restaurants, chargers)
        job = m.job(demand, rest, t, random.randint(10,25), cust_to_charge)
        jobs_na.append(job)
        
    for d in drones:
        d.move_to_goal(t,chargers)
    
    if not learning_weights:
        no_job_drone = [x for x in drones if x.job == 0 or x.job.state == 4 and x.battery >= 90]
    else:
        no_job_drone = [x for x in drones if x.job == 0 or x.job.state == 4]
    
    if learning_weights:
        s = time.time()
        score_matrix = m.NNscores(no_job_drone, jobs_na, t, learning_weights,len(drones))
        if time.time()-s > 0.008:
            slow = True
    else:
        score_matrix = m.simpleScores(no_job_drone, jobs_na, t)
    idx_drones, idx_jobs_na = m.hungarianMethod(score_matrix)
    
    for idx, drone in enumerate(idx_drones):
        if int(score_matrix[drone,idx_jobs_na[idx]]) != 100000:
            no_job_drone[drone].set_job(jobs_na[idx_jobs_na[idx]])
            jobs_a.append(jobs_na[idx_jobs_na[idx]])

    # added for KPI 
    for job in jobs_a:
        if job.state == 3:
            jobs_c.append(job)    
            
    jobs_na  = [x for x in jobs_na if x.state == 0]
    jobs_a   = [x for x in jobs_a if x.state != 3]
    
    return jobs_na, jobs_a, jobs_c, slow

# This function generates the required agents for the simulation (drones, restaurants, chargers)
# And optionally adds some demand at t = 0
def gen_agents(size, d_input, r_input, c_input, num_pre_dem = False, peak_loc = False):
    
    drones = []
    if type(d_input) == int:
        for d in range(d_input):
            drones.append(m.drone([random.randint(0,size[0]),random.randint(0,size[1])],d))
    else:
        for idx, d in enumerate(d_input):
            drones.append(m.drone([d[0],d[1]],idx))
          
    restaurants = []
    if type(r_input) == int:  
        for r in range(r_input):
            restaurants.append(m.restaurant([random.randint(0,size[0]),random.randint(0,size[1])]))
    else:
        for r in r_input: 
            restaurants.append(m.restaurant(r))
            
    chargers = []
    if not c_input:
        c_loc = [[size[0]/4,size[1]/2],[size[0]*3/4,size[1]/2]]
        for c in c_loc:
            chargers.append(m.charge([c[0],c[1]]))
    elif type(c_input) == int:
        for c in range(c_input):
            chargers.append(m.charge([random.randint(0,size[0]),random.randint(0,size[1])]))
    else:
        for c in c_input:
            chargers.append(m.charge([random.randint(0,size[0]),random.randint(0,size[1])]))
           
    jobs_na = []
    if num_pre_dem:
        for i in range(num_pre_dem):
            demand = dem.mapGenerator(size,False,peak_loc)
            rest, cust_to_charge = m.pick_restaurant(demand, restaurants, chargers)
            job = m.job(demand, rest, 0, random.randint(10,25), cust_to_charge)
            jobs_na.append(job)
        
    return drones, restaurants, chargers, jobs_na


# Used for debugging and quick testing of weights or idfferent implementations
if __name__ == "__main__":
    
    import time as times
    s = times.time()
    #weights = [[[-0.6465158240028306, -0.8540716180356156, -0.025125907230144184, -0.4792948948300919, -0.638717853231259, -0.8256100347908912], [-0.2093785540981452, 0.09871000143515984, -0.8253923467430099, 0.7865098711714367, -0.4490660201692427, -0.8068015789396616], [-0.6763729230742075, 0.1801345546486975, 0.8686924858184804, 0.31635692063842463, 0.07508014573406951, -0.0721668928093544], [0.4686982041143368, -0.23741873212624465, 0.848681781706088, 0.5810639382149372, 0.5149452260063287, -0.4513940274637918], [-0.5727590220427272, -0.2515440512725977, 0.062228433716950304, 0.6239107285186785, 0.6129573145618088, -0.7935113666290194], [-0.004058500730803993, -0.22513340321792397, -0.75083181006274, 0.6563212304069488, -0.9347482603316792, 0.443730865173146]], [[0.5802590518772672, -0.8504098879234051, 0.3687868190350413, -0.7840539180245767, 0.19699223210492334, 0.8140708348317123], [-0.1838203215712928, -0.09663786999157442, 0.43799366555857244, -0.2556772119499801, -0.9357626297614854, -0.08702734877771329], [0.6852480024516674, 0.9386193077838099, 0.8257600070840234, -0.4197614633180766, -1.2081088844220673, -0.593468309816856], [-0.4599263718254035, -0.9135919977121247, 0.4699776638481288, -0.6703259769060106, -1.0142752300849023, 0.905884853732541], [0.11117858228780819, -0.48081821127385127, 0.3658379245008243, -0.7602976471972409, -0.7776782357981751, 0.6517295666791536], [-0.01870036731058744, -0.8321637696553024, 0.2517220944354661, -0.05733534282305852, 0.6087295704636126, -0.631547619416726]], [[-0.5606217409129626, -0.8426133610907682, -0.3109168370622901, -0.12229200601662576, -0.3967957595411669, -0.6234152916039384]], [[1.4451354866041866, -0.4676364873712131, -0.2708169654517649, -0.0533581807103628, -0.38801848996518995, 0.40225907214368517, 0.6592650853656787, -0.37640970672704777, 0.764178253531608, -0.25419616201888234, 0.3936028039614796, -1.023187186206499, -0.8526011199556189, 0.027163717209388816, 0.26424548215684274, -0.5388745632350458, 0.9170003035581682, -0.563322807067584]]]
    
    #weights = [[[-0.6755558554158432, -0.044844679516200525, -0.6094876599051942, 0.2737481074312089, -0.7257682144782567, 0.6189392459494139], [0.07103154314327154, 0.340530246039179, -0.14050479820821682, -0.7406758067077291, 0.4310387430924445, -0.8048096864044345], [-0.8119769258050626, -0.17464088254827148, 0.5705278005996628, -0.32727730521751974, 0.9081521372159158, -0.1410091849152708], [0.40665491782192187, -0.724164576893225, 0.13717660661144251, 0.2666683395622387, 0.27176813718769727, -0.9064521718856235], [0.7480805376813171, 0.4809484033720557, 0.4319976839605508, -0.30943814752718785, 0.2571889679101234, -0.6958876231132269], [0.25330788133392357, 0.40220013919122355, -0.8480508793026567, 0.28053260696132953, 0.11682248881676452, 0.989263937266645]], [[0.10495813967370049, -0.9013336487308627, -0.8997374867802013, -0.22156035395024976, 0.25693534356128156, 0.6679857334347559], [-0.23314697709800525, -0.716689126167106, 0.368134572483656, 0.174344255764195, 0.36072230563647056, 0.25100446595447934], [0.032366588015235065, -0.8321414077236089, 0.7715906270121977, -0.3021731680266933, -0.38984810505951506, 0.9174601816560979], [-0.5148827777634009, 0.43261664278465983, -0.6559072704992013, -0.8496685721974346, 0.629194986052465, -0.3294183282011278], [0.6605804719820769, -0.5521008898829025, -0.9764609485128111, -0.697212717219619, 0.20492061402797845, 0.7348376098320686], [0.12181183981447732, 0.18478049964464605, -0.6215644650470704, 0.9042887556860868, -0.13608975940923068, 0.992357503003902]], [[1.0268872541187875, -0.35628773599380636, 0.9695443071416514, -0.33165119987344016, -0.19457282145080318, 0.08668548497276873]], [[-0.1656496519575318, 0.14742065577331487, 0.15346881572631993, -0.41565758302679257, -0.008216102744190268, 0.556731690068385, -0.1445985562407756, -0.9882729760373028, -0.8713700291959556, -0.3011103062196927, -0.8560993663944836, -0.44069457792645594, -0.9047282879168063, 0.5706512896790767, 0.45964697502294216, -0.7739819801512009, -0.19495836333278493, -0.19009498411561876]]]
    
    #weights = [[[-0.20112574265378114, -0.09488583014681984, 0.5525736106916712, -0.19556667837628172, -0.5499184834660497, 0.21503938621309482], [-0.2610151515695589, 0.8492862471051692, -0.36528656255609926, 0.48239396195106915, 0.8838405063293233, 0.8236519119747026], [0.7012704774470435, 0.7225381781494404, -0.015386243575537195, 0.3578068926079647, -0.8269585537727826, 0.4612382907306598], [0.4156500937450016, -0.4667813973225303, 0.6747258467999586, -0.8559899503686421, 0.5164319769621217, -0.9539348953423612], [-0.558669677293522, 0.06049023975185491, 0.15539586276576056, 0.7932084431529343, -0.5357607754087115, 0.05568507208857065], [0.35351298305074397, -0.2933180604582455, -0.7350098944077423, 0.8840621267895346, -0.7901523620831181, 0.5298092190730144], [-0.1147762788061435, 0.241713858386453, 0.18986273203031012, -0.6880281880848427, 0.9214983971167396, -0.6636897301795217], [-0.08923270788787163, 0.7700059639048746, -0.9946936208438939, 0.8756320403545288, -0.49762768912101807, 0.35974231852905536]], [[-0.3889946658063337, 0.6497124275299702, -0.22053823543595152, 0.030408352329619692, -0.6429312275925514, 0.9290776111562926, 0.03354811890475151, -0.3733148417571317], [0.6315935138449502, -0.5367877950058619, 0.5978708530579608, -0.803111639605669, 0.42103101644210583, -0.5771267636478064, 0.042455948741279226, -0.7531839466679988], [-0.5284975544816699, 0.3076461828175612, 0.7902172701219843, -0.7102146255577741, 0.09708942628130157, -0.1093406909575263, 0.07650521024282475, -0.9736143066624376], [-0.5791101774475995, 0.40920138138809986, 0.949242289035841, 0.14614047309235834, 0.5441747915762325, -0.09768062656976095, -0.8651894903702887, -0.3599583536337294], [0.8257309680982461, 0.5793985779770054, -0.061660760599630215, -0.9670367002029194, 0.8303912020077946, 0.5525318127204446, 0.642917543598529, 0.11345509767161532], [0.9328656511444909, 0.8568243113853518, -0.39023178086787125, 0.0712709036584358, 0.37445541217459355, 0.11547018566294032, 0.6519798615631729, 0.2614790230633952]], [[0.199331517960192, 0.8498023620932738, 0.685033363274794, 0.8464990823701314, 0.20131166533585793, -0.6194014763271949]], [[-0.6585162056050151, 0.38840325476205906, 0.4145451240692881, 0.471834696054368, -0.005592803830066995, -0.2017130720240974, 0.79958203254954, 0.6445245741194852, 0.6061386254495289, 0.659941233301085, 0.8692365009104803, 0.0639587238945647, 0.37701339900109976, -0.926664829242654, -0.9195649454989416, 0.9703674382824132, 0.7426090530872171, -0.35204266794626626, -0.1803535670994929, 0.05353053384128459]]]
    
    #weights = [[[0.41689596070806445, -0.7990908957999083, 0.5525643799953843, 0.52711695916912, 0.5254601827119505, -0.3880248704081146], [0.41811970216008554, 0.8862213121619216, 0.3233368735458413, 0.27121182883977113, 0.8361198577632496, -0.38355735580719935], [-0.3301202355165094, -0.24111698429626172, -0.9856844279474613, 0.27722837799815014, 0.5280142748787644, -0.1272066738473534], [0.008693147175827809, 0.46897172490319283, -0.10695209357931046, -0.08755485679034347, 0.3520104481351336, -0.20247234721837293], [0.35438103143527133, -0.21495567573609375, 0.7799322533808322, -0.3444233269070158, 0.31950869551284056, 0.5048380134534554], [-0.15791207490597858, -0.1917881369930201, -0.9655988086063048, 1.039897575310469, 0.46179535551154305, -0.6414811712071768]], [[-0.4239765456810596, 0.5773793542802574, -0.30842254112207446, 0.05883996003285652, -0.7408837538479305, 0.9672103337018401], [-0.7223421443069088, 0.43251954825272787, 0.03530029598090212, 0.47009391044101384, 0.8095199097755799, 0.41325873270545177], [0.7307027735653377, 0.07138060752108966, 0.5745593528150468, 0.6213851516941966, 0.9484940169096092, -0.2239557931272811], [0.001167288026052482, -0.8711419486069596, -0.051418947829814377, -0.6068091758781702, -0.6652011566358671, 0.41169354925676394], [0.9383391596164468, 0.1528349561534293, -0.830690046572528, -0.28837704985091595, 0.8423733735702008, -0.26180798433163743], [-0.7456298928734415, 0.5467821526690373, 0.02659211354392066, -0.024178446785330543, 0.8062737574984478, 0.22648776421385763]], [[0.4184452130937512, -0.14488596608812987, 0.35456287186596636, -0.7344543941317625, -0.017399343568249903, -0.39539847824578844], [0.9162265075264304, 0.888996563604588, -0.285925987199257, 0.6759141427435273, -0.24852096862574147, 0.42105372149940856], [-0.27042768170064835, -0.287489483919517, 0.45582147144720064, 0.6641757598281051, 0.7755832842365589, 0.5503154008418158], [-0.9173449178926931, 0.7471765507097969, 0.9763155270889763, -0.4567703236062157, 0.10657309699075812, 0.12274098482476536]], [[-0.4609518482300061, -0.9646770607247772, 0.11622846502258288, 0.524291685821523]], [[-0.6403738515449326, 0.7579496257805065, -0.5368817311497713, -0.8837070959909961, 0.6668709539164575, -0.7438612013476757, 0.861834505972289, -1.1447068905533495, 0.7398283282923028, -0.15661701190397503, 0.9850046348016261, -0.5453125706459785, -0.8787997482182119, 0.4240887417376755, -0.856740842489885, 0.7377541648099637, -0.19193791893677092, 0.4746028697828313, -0.43114647021919694, 0.9265659312738466, 0.1369216187066169, 0.4702687985081979]]]
    
    #weights = [[[0.0634853790759966, 0.3826631587772218, 0.4236892177490603, 0.680122907121363, -0.38080911000385087, -0.73690859211672], [-0.31650536528538664, 0.3874503286068779, -0.3162025181115611, -0.3936277470768178, -0.6481598761886045, -0.8783291123349619], [-0.893443951407238, 0.3989718813011005, -0.5272413735899104, 0.016572026921704425, 0.12465361092423644, 0.7668775566296966], [0.6556762764034014, -0.3167333434428461, 0.3671292382698861, 0.6968427053466459, 0.6368106165518448, 0.9934321159953097], [-0.5268961516752413, 0.3950922005177131, 0.1100550398062386, 0.036855820961868346, 0.563665514240641, -0.2881709164574042], [-0.4604978968258273, -0.2969697898342727, -0.47137927700800075, 0.13765653605153405, -0.14476059524923657, 0.5851145774071143]], [[0.4650045968877172, -0.7707814669066964, 0.6028881446525505, -0.12607709144563573, 0.8688328653428452, -0.8083145909718426], [-0.4468392175174398, 0.29807823966013647, -0.5487025463120678, -0.2726424143189814, 0.8883702967305729, -0.8201511186481316], [0.5030736662744866, -0.6760608055424113, -0.6264260550658982, 0.1425712025848354, 1.0287320643053395, 0.3920834391558954], [0.6128306840837996, 0.3486096977765456, -0.04002784455646724, 0.3501650987283062, 0.3438546979329242, -0.9158808923599959], [-0.08017295431060756, 0.22116336641581547, -0.7215368955769328, -0.042621189211460964, 0.8426923258227728, 0.01408743235482196], [0.4981108664465199, -0.5218048863091018, 0.2416199021459151, -0.8452094929707066, 0.4652829695127596, 0.09399777535415232]], [[-1.0659412151364254, -0.6648826282729361, 0.2172803361380946, 0.150453431661844, -0.4013924835795414, 0.2508877400407376], [-0.592177727783264, 0.09546095099414398, 0.634169671695582, -0.8864200839766729, 0.34035215875931435, 0.5749509039851726], [-0.2040139938940626, -0.2541654432657413, -0.9047441708960184, -0.13963452192428205, 0.8911286025714387, 0.09255233706659571], [-0.024091608506800588, -0.36081201591273504, -0.35879936642529, 0.3507951387359783, 0.6418403121066141, 0.4783015273056136]], [[-0.22710748738960929, -0.6318054336247805, -0.828223374000665, 0.34595290772562715]], [[0.14899970125755835, 0.8362313418645488, -0.3710336362400688, -0.21498922377947705, -0.470196929993951, 0.22073403591915763, -0.39793660534768627, -0.3496054186302523, 0.34667773121312623, -0.3583768051635505, -0.007095575142562538, 0.8987615240446614, -0.0005058854834270043, 0.98813616677188, 1.124796722093522, -0.32571743636542916, -0.17580636537189864, -0.010327358384964347, 0.9861115479780318, 0.5705700709535082, -0.9390895310960459, -0.6529715741626314]]]
    
    #weights = [[[-0.030758829703960433, -0.7500109477843598, 0.45883729713511023, 0.13323639108520302, 0.9818332209173466, 0.13338064619492807], [0.8014145944569695, 0.17418181512007425, 0.7614781831067239, 0.24962881622120983, -0.5288359091594377, 0.6479650486197943], [-0.6918994691184539, -0.48037992721423717, -0.3352228912237907, -0.02932050360554883, 0.15185495480268285, 0.029155962161229843], [-0.906784941565353, -0.3711776018439874, -0.30099183715295297, 0.7130957598068408, -0.7215632936973944, 0.6795714901805043], [0.8388973345177484, 1.0183457869557329, 0.5503480635756604, -0.40506992725931, -0.415507698506528, -0.44047063661939445], [-0.032349842698248255, 0.33049727768828396, -0.6939072810957168, -0.2878348568948318, 0.9449849327183126, -0.6718101999565669], [-0.19525807927735195, 0.7816968716611463, 0.35589547899154494, -0.6447220820472126, -0.32844218376139644, 0.025626089261564067], [-0.5028044004901444, 0.4350263623092343, 0.6899889428540043, -0.032869676360546995, -0.9756147756864166, 0.02551659901808012]], [[0.2546905953504237, 0.23629745868255125, -0.28101402447356705, -0.42136110289884665, -0.18860317317741337, 0.59569880580994, 0.29152640055077805, 0.5294446223129209], [0.19726327354300083, -0.46399835356213504, -0.8728627306864332, -0.37289148030854635, -0.38815844581916004, 0.41770308694527386, -0.6645092213506605, -0.2469640233719556], [-0.2606805303642601, 0.01982587336906444, 0.3378764129602297, -0.6113229311872677, 0.12318362685030126, -0.8823852908994936, 0.792438051417435, 0.32373369134936003], [-0.43165677070211705, 0.5269134118828764, -0.8988290512701633, 0.5097889316114106, 0.2113510181372562, -0.8380980013784791, 0.22120158068885343, 0.46311106723150197], [0.12009440413805628, 0.8772801009667919, -0.7633822747427559, -0.31369305145143955, -0.9150051604847813, 0.7842987797727115, 0.25608722615663293, -0.875415689353553], [0.7864615758744331, 0.13399215420242072, 0.6218625251968926, 0.9849673516972968, 0.7945077036769088, 0.3948570285301205, -0.8726646653359875, 0.6056258297657457]], [[0.29444256713210853, 0.7632106123923921, 0.320273110197698, -0.8613199765527648, 0.8959159263174901, 0.38547499909152405], [-0.5267038460903264, 0.5381044770581933, 0.7262848363018521, 0.49000264326069637, -0.8551800337313427, -0.018642593984193878], [0.6501327230291988, -0.32248584993839813, 0.5449750789974648, -0.4956079566038503, -0.9913730956050388, -0.37113898835450376], [0.5885057619107272, 0.8141968266490638, 0.4524684024320613, 0.047721426375062215, 1.028911604911443, 0.30001036443193096]], [[-0.20573678082551192, 0.7892355257936838, -0.8312833476930543, -0.12428531281857946]], [[0.20747065755616223, -0.8982843947064072, 0.563195875767524, -0.9945645355394199, 0.5784565627820687, 0.1015954296414942, -0.9657672278266405, 0.294278069975784, 0.4982005652746806, -0.7164934904356446, -0.20280811715777403, 0.6225802741105959, 0.41673678293534167, 0.23085221294208047, 0.34966011844733497, 0.797430162921257, -0.7310428886706213, -0.9727452122368885, -0.5987297849010544, 0.4523299026990309, -0.09809671072708798, -0.5158226561825738, 1.1060149107412298, -0.8819065425158221]]]
    
    #weights = [[[-0.4912403906555445, -0.17507154395844915, -0.9160153470982602, -0.7038651979089978, 0.25065703268661044, 0.9032490078382085], [-0.5332772989000716, -0.06289885184960586, -0.7040413925047058, 0.18010381041586632, 0.8274783692755787, 0.9576265757136755], [0.9926284875324187, -0.627986335281117, -0.4154015866857699, 0.9597320566478389, -0.29748206843464503, -0.9369662343117187], [0.9570269908564017, -0.06556607993023933, -0.6083403769560143, -0.6093651892819976, -0.009830320911068835, 0.7643728971042891], [-0.42056800143205786, -0.39759536487810393, 0.9364696892893472, -0.4251747692805212, -0.2128596850493183, -0.7364051578402975], [0.11254982780018863, 0.7668893029794024, -0.9258607541509278, -0.6755497645678221, -0.15117230651518138, 0.8664835314916237], [-0.2179622969816819, 0.38184962805502076, 0.24836400916808588, -0.9299628721018892, 0.5511279830391569, -0.9467454896797856], [-0.4061965555050495, -0.14432223784230747, 0.3415966750703394, 0.032682651742925506, 0.6151308423960462, -0.3040781927746621]], [[-0.8054585885608425, -0.19755875660984956, 0.15101873071544558, 0.13633325572842092, -0.8907479227864066, -0.20973773063765577, 0.4923268602639226, -0.06947490654238186], [0.7021344988342275, 0.19059421817840105, -0.051013357561978, 0.9331657121827035, -0.024788807767460064, 0.4960895172478115, -0.1417201163904061, 0.8098101787105094], [0.07231865821789474, -0.19865077895836425, -0.1870417793736494, 0.843877529005091, -0.7523047968547658, 0.3812383771060018, -0.0717818004261348, 0.7800142406357389], [0.7502374820269313, -0.04545497507817983, 0.49725106653575923, -0.6728691109002731, 0.8925153905147489, -0.6154232951358098, 0.7368479456558561, 0.10346969996755662], [-0.2688266524263694, 0.16132832985152146, -0.692253746750549, 0.2462552418280195, -0.4970325642505615, 0.9111241015654914, 0.5358080892846973, -0.1080810715497158], [0.1943819389450529, 0.5301572898497058, 0.059698545551432725, 0.689983331009463, -0.6133314752134418, -0.47023209673599964, -0.5760605472824905, 0.7412222325164155]], [[0.7660796523968338, -0.9326219071978084, -0.84834778525068, -0.908323760568583, -0.5420553674783579, -0.017073359441130753], [0.22388014446996518, -0.21563457540133735, -0.40097057946819725, -0.4654589030344609, -0.7385675074450404, 0.42699767230361707], [0.26520678805132725, -0.5615311330852064, -0.11935198597421853, -0.8855505468602549, -1.0673945364809807, -0.964563717705601], [0.5283655276551817, 0.049280533473337274, -0.4152314140757243, 1.0840202873716596, 0.5259366064331394, 0.25219808660456455]], [[0.3848539856638833, 0.18574252330521124, 0.815060223807786, -0.19854713757294484]], [[-0.2011384733201229, 0.17861822734752253, 0.42627874314756364, 0.840628420013878, 0.17328249975943977, 0.4569362408226838, -0.24035528735685752, -0.9583203347285913, -0.04188429762479706, -0.48853522346853073, 0.5919354365375138, 0.9722942984248122, 0.23111299786319228, 0.03261003723312461, -0.035148770916066774, 0.7780670282695676, -0.13414906302712737, -0.7524179166691465, -0.15358919385347747, -0.62494158082365, -0.294576925062916, -0.9078802828924895, 0.2750421182846141, -0.870310548489994]]]
    
    #weights = [[[-0.5160815665188591, 0.3891311518580667, -0.0008461525114100699, -0.2542813243324486, 0.12175528695525786, -0.4739880783519749], [-0.941525670770851, -0.5950246097965931, 0.8300378053238834, 1.3424390807818494, -0.9671865310312587, -1.317647958654424], [0.3444262446373631, 0.23301416029700678, 1.6709686408345714, -0.0007660248918250345, -1.7086156380742237, -0.15160064634186957], [0.6060361024880536, 0.6754103116085011, 0.9227226750385149, -0.49695573729588166, -0.6889795038342338, 0.14477443183473104], [-0.3549151344952578, 0.5998731927048246, 0.5034783114515373, -0.3683614212834073, -0.19348365695133524, 0.5442536164803616]], [[0.050548308929039526, 0.1920755422120763, -0.37012778567192983, -0.5263036613094377, 0.662700582287991], [0.3362932395058054, 1.4854437728610215, 0.2060484474191393, -2.441337954703754, -2.22319460657057], [1.0247349860262078, 1.57567481790263, 1.5349292068302434, -0.9886526496927596, 0.25586944899629155], [0.10653614825133734, 0.971462792514801, -0.07631991842330299, -0.7819338450211828, -0.5775432905919061], [1.4683509381865436, -1.953931425386908, 0.6584965825489844, 0.682449952184357, -0.3389242926216558]], [[0.006337540898839977, -0.24350452153256635, 0.11649420366644891, -0.567880268549521, -0.030988344347123747]], [[-0.6992609795079348, 0.1653716840540028, 1.1569308558993445, -1.0900780860103676, -0.7094022290830697, 1.7695160125863276, -1.3388105919344362, 2.215856097989138, -1.8203827571236912, 0.35603589187645635, -1.688895697902666, 0.9098923982439827, 0.5089313815826693, 0.5680286066666141, 0.27382801337926843, -0.7898455609267239]]]
    
    #weights = [[[-0.4427207775202229, 0.3073749583171637, 0.5801724374586398, -0.5172645596594238, -0.6263684398490001, 0.9975465924465663], [-1.5013180558467702, 0.2575056909422898, -0.2022817182488003, -0.06895379049655553, -1.0263590212477263, 0.7589538478360831], [0.30574422986022, 0.2522717386399999, 0.9150362254435818, -0.6690586880967013, 0.4129529638298031, -0.4521454550058425], [-0.4828212503328405, -0.9394420509441586, -1.1645797765376225, 0.2119674395659072, -0.34560642527550345, 0.2111918527055145], [0.4946649788395478, 0.4107884408886606, 0.18039870429501176, 0.215806110674866, -2.2724935101507855, 0.3479994446845388]], [[0.5604020133432125, -2.029169978426369, -3.7445351810427256, -0.7901445092571932, -0.29309126362483456], [0.04212308475341606, -1.0656769849861778, 1.0857440797133007, -0.4145179643797874, -0.8367500129816505], [0.37916435950066474, 0.3567027696707436, 0.9962364486077114, 0.6672795195493086, 1.0919109429845653], [0.2018611428077573, 0.04256871754145242, 0.9704244547958614, 0.775672978677523, -1.4192605837849295], [0.3147623343371925, -0.14165812115405757, -0.8352896952796953, -0.08002563708167204, 3.9346305184035555]], [[-1.3324516610142934, 0.9992794965681673, 0.09883679924662056, 1.3195678458756934, 3.2847328317435593]], [[-0.8519317570521285, -0.7261674075500835, -0.20139465411621016, -0.8464880992573396, -0.8864464369478352, 0.1865664850735264, -0.7165318496602466, 1.1080132958631113, 0.5661732408620863, 2.104395910361168, -1.3320828104870186, -0.6832217642962746, 0.57792489124382, 0.8792881514781072, 0.2796455851846118, 2.5006371229549873]]]
    
    #weights = [[[-0.31867500323634823, -0.9572249731324957, 0.5321680554812807, -0.11938190112920893, 0.8219224375466235, 2.786986393528162], [-0.6723205606215029, 0.43388963228699096, 0.06296367618716436, -1.2182556569324883, 1.9282689429612412, -1.696744795020412], [-0.4657901494711706, 2.196018065108488, -1.3283226221952125, -1.2252121660364121, 1.7651638425118792, 0.543680516675771], [-5.068516895273696, -5.028548725906976, -1.00547441073084, 14.47964703946219, -2.6560141174550203, -2.6570607084209823], [0.25908925973812136, 3.911736598166933, 0.7799159177231074, 0.03149328162553422, 0.3751697651174019, -2.078103784818724]], [[1.382320508454909, 0.5355164478200967, -1.7753031834248176, -4.373271471837427, -0.3502506760376969]], [[1.0427323341730774, 0.19857315405259124, -0.6047495476839351, 1.3361828415586814, -1.8657661087587945, -4.530016045910362, 0.3661320169060766, -2.574273292479872, -2.1352970511239047, -0.26432730895120715, -0.592898455341327]]]
    
    weights = [[[0.5425818994812044, 0.7884125502889743, 0.5370358095736112, 0.9803392155751924, 0.5591310671036198, -0.596428631402359], [0.6205195608600576, 0.37132973395758007, -0.49466236301352096, -0.07054512775911492, 0.11691501811949001, -0.2564650713288532], [0.9591643761027309, 0.8725909115853605, -0.47757390272260514, -0.19264286414816234, 0.37435313011671334, -0.0762266094891737], [-0.18410891640094884, -0.9571509998104464, 0.12445095073171619, 0.57716999494724, 0.17094850981486576, 0.5921090749168296], [0.3214503517196752, 0.9908970713850407, -0.98934675446673, -0.8079114751575978, -0.3401852173589872, 0.3296155533974092]], [[-0.5109212645746832, 0.15964569469869616, 0.32892872717632016, 0.46319875880257144, -0.8151103046444061], [0.7007386228744628, 0.6377427299560454, -0.08120009860208577, 0.863371014625594, -0.06473446332863908], [-0.17153508594314815, 0.42008206256088254, -0.43911726611502355, 0.2804508699306356, -0.005345098005012483], [-0.9675391406053531, 0.739834714878749, 0.939171021149001, 0.3733528692008452, 0.1759559498002572], [0.5990753927945507, 0.9725876053635651, -0.2945947356010521, -0.6449942617426623, 0.5384830652713102]], [[-0.971255520653987, -0.5355102946931358, -0.8129076255164576, -0.4969511928089634, -0.4122513638385137]], [[0.9553482661845778, 0.5003034045946677, 0.8234679415149275, -0.8699931890808765, -0.47200652761264816, -0.33332947725929407, 0.33679350148220655, 0.46316863957310317, -0.40686481407531616, 0.3134901565175394, -0.5077771227941319, 0.045141058816638546, 0.5643267626345156, -0.8326066484007812, 0.6097656277130961, 0.7551822866080231]]]
    
    weights = [np.array(x) for x in weights]
    #weights = False
    size = (1000,1000)
    
    tot_scores = []
    for i in range(20):
        
 
        # drones, restaurants, chargers, jobs_na = gen_agents(size,7,[[300,300],[450,400],[700,500],[550,700]],False,5,False)
        drones, restaurants, chargers, jobs_na = gen_agents(size,12,8,False,5,False)
        
        jobs_a = []
        jobs_c = []
        sim_lenght = 1000
        
        t = 0
        run = True
        while run:
            
            jobs_na, jobs_a, jobs_c, slow = main_loop(drones, restaurants, chargers, jobs_a, jobs_na, jobs_c, t, 0.2, size, False, weights)
        
            t += 1
            if t == sim_lenght:
                run = False
        
        utilisation = []
        delay = []
        for d in drones:
            utilisation.append(d.utilised_counter/1000)
            delay.append(d.order_delay)
            
        delay_jna = sum([sim_lenght - x.complete_time for x in jobs_na])
        delay_ja = sum([sim_lenght - x.complete_time for x in jobs_a])
        delay = sum(delay)
                
        #scores = (sum(utilisation)*100/7)
        scores = (1/(delay + delay_ja + delay_jna)*10000)
        print(scores,sum(utilisation)/len(utilisation))
        #print(delay + delay_ja + delay_jna,len(jobs_na)+len(jobs_a))
        
        tot_scores.append(scores)
    
    print(sum(tot_scores)/len(tot_scores))
    print(max(tot_scores))

    print(times.time()-s)

        
